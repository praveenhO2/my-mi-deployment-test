name: Version Bump for .car files

on:
  push:
    paths:
      - 'LMS/*.car'
      - 'CRM/*.car'
      - 'ERS/*.car'
      - 'Enterprise-Services/*.car'
      - 'HR-Finance/*.car'
      - 'Membership/*.car'
      - 'Travel/*.car'
      - 'Utilities/*.car'

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository using PAT
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0  # needed to compute diffs

      # Step 2: Process folders and bump versions
      - name: Detect .car changes and bump versions
        run: |
          folders=("LMS" "CRM" "ERS" "Enterprise-Services" "HR-Finance" "Membership" "Travel" "Utilities")

          echo "Checking which folders have .car changes..."

          for folder in "${folders[@]}"; do
            version_file="$folder/version.yaml"

            echo ""
            echo "---------------------------------------"
            echo "Processing folder: $folder"
            echo "---------------------------------------"

            # Detect .car changes since previous commit
            changed_files=$(git diff --name-only HEAD^ HEAD -- "$folder"/*.car || true)

            if [ -z "$changed_files" ]; then
              echo "No .car changes detected in $folder. Skipping."
              continue
            fi

            echo "Detected changed .car files:"
            echo "$changed_files"

            # Ensure version.yaml exists
            if [ ! -f "$version_file" ]; then
              echo "version: 1.0.0" > "$version_file"
              echo "Created new version file for $folder with version 1.0.0"
            fi

            # Read current version
            current_version=$(grep 'version:' "$version_file" | awk '{print $2}')
            echo "Current version for $folder: $current_version"

            # Split version
            major=$(echo "$current_version" | cut -d. -f1)
            minor=$(echo "$current_version" | cut -d. -f2)
            patch=$(echo "$current_version" | cut -d. -f3)

            # Increment version: patch first, rollover to minor
            patch=$((patch + 1))
            if [ "$patch" -gt 99 ]; then
              patch=0
              minor=$((minor + 1))
            fi

            new_version="${major}.${minor}.${patch}"
            echo "Updated version for $folder: $new_version"

            # Update version.yaml
            echo "version: $new_version" > "$version_file"

            git add "$version_file"
          done

      # Step 3: Commit & push updated version files using PAT
      - name: Commit & Push version updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if git diff --cached --quiet; then
            echo "No version changes to commit. Exiting."
            exit 0
          fi

          git commit -m "Auto version bump for updated .car files"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git HEAD:main

