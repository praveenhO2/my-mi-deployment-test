name: LMS Version Bump

on:
  push:
    paths:
      - 'LMS/*.car'

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:

      # Step 1: Checkout the repo using your PAT
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PATH }}

      # Step 2: Read current version
      - name: Read current version
        id: read_version
        run: |
          if [ ! -f LMS/version.yaml ]; then
            echo "version: 1.0.0" > LMS/version.yaml
          fi
          VERSION=$(grep 'version:' LMS/version.yaml | awk '{print $2}')
          echo "current_version=$VERSION" >> $GITHUB_ENV

      # Step 3: Bump version (PATCH first, minor/major rollover)
      - name: Bump version
        id: bump
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "$current_version"
          PATCH=$((PATCH + 1))
          if [ $PATCH -gt 99 ]; then
            PATCH=0
            MINOR=$((MINOR + 1))
            if [ $MINOR -gt 99 ]; then
              MINOR=0
              MAJOR=$((MAJOR + 1))
            fi
          fi
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version: $NEW_VERSION" > LMS/version.yaml
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

      # Step 4: Commit & Push updated version.yaml using PAT
      - name: Commit & Push new version
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add LMS/version.yaml
          git commit -m "Auto bump LMS version to $new_version"
          git push https://x-access-token:${{ secrets.GH_PATH }}@github.com/${{ github.repository }}.git HEAD:main
        continue-on-error: true
