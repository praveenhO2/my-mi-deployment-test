name: Multi-Folder Version Bump

on:
  push:
    branches:
      - main
    paths:
      - "**/*.car"

jobs:
  version-bump:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with PAT and full history
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0   # IMPORTANT: allows git diff to work

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Version bump for changed .car files
        run: |
          folders=("CRM" "ERS" "Enterprise-Services" "HR-Finance" "Membership" "Travel" "Utilities" "LMS")

          echo "Checking which folders have .car changes..."

          for folder in "${folders[@]}"; do
            version_file="$folder/version.yaml"

            echo ""
            echo "---------------------------------------"
            echo "Processing folder: $folder"
            echo "---------------------------------------"

            # Detect changed .car files (HEAD vs previous commit)
            changed_files=$(git diff --name-only HEAD~1 HEAD -- "$folder"/*.car || true)

            if [ -z "$changed_files" ]; then
              echo "No .car changes detected in $folder. Skipping."
              continue
            fi

            echo "Detected changed .car files:"
            echo "$changed_files"

            # Create version.yaml if missing
            if [ ! -f "$version_file" ]; then
              echo "version: 1.0.0" > "$version_file"
              echo "Created new version file for $folder"
            fi

            # Read current version
            current_version=$(grep 'version:' "$version_file" | awk '{print $2}')
            echo "Current version: $current_version"

            major=$(echo "$current_version" | cut -d. -f1)
            minor=$(echo "$current_version" | cut -d. -f2)
            patch=$(echo "$current_version" | cut -d. -f3)

            patch=$((patch + 1))

            if [ "$patch" -gt 99 ]; then
              patch=0
              minor=$((minor + 1))
            fi

            new_version="${major}.${minor}.${patch}"

            echo "Updating version to $new_version"
            echo "version: $new_version" > "$version_file"

            git add "$version_file"

          done

          echo ""
          echo "Checking if any version files changed..."

          if git diff --cached --quiet; then
            echo "No version changes to commit. Exiting."
            exit 0
          fi

          git commit -m "Auto version bump for updated .car files"

      - name: Push changes using PAT
        run: |
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git HEAD:main

