pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        // Keep build history manageable
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    triggers {
        // Poll SCM every 2 minutes (adjust as needed)
        pollSCM('* * * * *')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/praveenhO2/my-mi-deployment-test',
                        credentialsId: 'github-pat'
                    ]]
                ])
            }
        }

        stage('Check Changes') {
            steps {
                script {
                    // Get last commit message
                    def lastCommitMsg = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()

                    // Skip auto version bump commits
                    if (lastCommitMsg.contains("Auto version bump")) {
                        echo "Skipping build for auto version bump commit"
                        currentBuild.result = 'SUCCESS'
                        return
                    }

                    // Check if folder/version.yaml changed
                    def changedFiles = sh(
                        script: "git diff-tree --no-commit-id --name-only -r HEAD",
                        returnStdout: true
                    ).trim().split("\n")

                    if (!changedFiles.any { it == 'folder/version.yaml' }) {
                        echo "No changes in folder/version.yaml, skipping deployment"
                        currentBuild.result = 'SUCCESS'
                        return
                    }

                    echo "Detected change in folder/version.yaml, proceeding with build"
                }
            }
        }

        stage('Deploy .car') {
            steps {
                script {
                    // Example deployment step - replace with your real commands
                    echo "Deploying .car file..."
                    sh 'ls -l folder/*.car'  // List the .car files
                    // Add your deployment command here
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished with status: ${currentBuild.currentResult}"
        }
        failure {
            echo "Build failed!"
        }
        success {
            echo "Build succeeded!"
        }
    }
}

